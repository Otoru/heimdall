name: Helm Chart Release

on:
  release:
    types: [published]

jobs:
  package-and-push-chart:
    if: ${{ startsWith(github.event.release.tag_name, 'chart-') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Package chart
        env:
          TAG_NAME: ${{ github.event.release.tag_name }}
        run: |
          VERSION="${TAG_NAME#chart-}"
          mkdir -p dist
          helm package charts/heimdall --version "$VERSION" --app-version "$VERSION" --destination dist
          echo "CHART_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Login to GHCR for Helm
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username "${{ github.repository_owner }}" --password-stdin

      - name: Push Helm chart to GHCR
        run: helm push dist/heimdall-${{ env.CHART_VERSION }}.tgz oci://ghcr.io/otoru/heimdall-chart

      - name: Upload chart to release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/heimdall-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
